name: Phase 6 - Comprehensive Test Suite
on:
  pull_request:
  push:
    branches: [main, develop]

permissions:
  contents: read

env:
  TESTING: "1"
  JWT_SECRET_KEY: "test-secret-key-for-ci-testing-only"
  DATABASE_URL: "sqlite+aiosqlite:///./test_suite.db"

jobs:
  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -e .
          pip install -r telegram_poker_bot/requirements.txt
      
      - name: Run backend unit tests
        run: |
          pytest telegram_poker_bot/tests/backend/unit -v --cov=telegram_poker_bot.engine_adapter --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: backend-unit
          name: backend-unit-coverage

  backend-integration-tests:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -e .
          pip install -r telegram_poker_bot/requirements.txt
      
      - name: Run integration tests
        env:
          DATABASE_URL: "postgresql+asyncpg://postgres:testpass@localhost:5432/testdb"
          REDIS_URL: "redis://localhost:6379"
        run: |
          pytest telegram_poker_bot/tests/integration -v --cov=telegram_poker_bot --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: backend-integration
          name: backend-integration-coverage

  api-contract-tests:
    name: API Contract Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -e .
          pip install -r telegram_poker_bot/requirements.txt
      
      - name: Run API contract tests
        run: |
          pytest telegram_poker_bot/tests/api -v --cov=telegram_poker_bot.api --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: api
          name: api-coverage

  websocket-contract-tests:
    name: WebSocket Contract Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -e .
          pip install -r telegram_poker_bot/requirements.txt
      
      - name: Run WebSocket contract tests
        run: |
          pytest telegram_poker_bot/tests/websocket -v --cov=telegram_poker_bot --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: websocket
          name: websocket-coverage

  analytics-tests:
    name: Analytics Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -e .
          pip install -r telegram_poker_bot/requirements.txt
      
      - name: Run analytics tests
        env:
          DATABASE_URL: "postgresql+asyncpg://postgres:testpass@localhost:5432/testdb"
          REDIS_URL: "redis://localhost:6379"
        run: |
          pytest telegram_poker_bot/tests/analytics -v --cov=telegram_poker_bot --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: analytics
          name: analytics-coverage

  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install black ruff mypy
      
      - name: Run Black
        run: black --check telegram_poker_bot pokerkit
      
      - name: Run Ruff
        run: ruff check telegram_poker_bot pokerkit

  pokerkit-tests:
    name: PokerKit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run style checking
        run: flake8 pokerkit
      
      - name: Run static type checking
        run: mypy --strict pokerkit
      
      - name: Run unit tests
        run: python -m unittest
      
      - name: Run doctests
        run: python -m doctest pokerkit/*.py

  migration-dry-run:
    name: Database Migration Dry Run
    runs-on: ubuntu-latest
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -e .
          pip install -r telegram_poker_bot/requirements.txt
      
      - name: Run migrations
        env:
          DATABASE_URL: "postgresql+asyncpg://postgres:testpass@localhost:5432/testdb"
        run: |
          cd telegram_poker_bot
          alembic upgrade head
      
      - name: Verify migrations
        run: echo "Migrations completed successfully"

  coverage-report:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [backend-unit-tests, backend-integration-tests, api-contract-tests, websocket-contract-tests, analytics-tests]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "All test jobs completed"
          echo "Check individual job coverage reports"
