version: '3.8'

services:
  # Git Clone Service - Clones the repository
  git-clone:
    image: alpine/git:latest
    container_name: pokerbot_git_clone
    volumes:
      - ./repo:/repo
    environment:
      - GIT_REPO_URL=${GIT_REPO_URL}
      - GIT_BRANCH=${GIT_BRANCH:-main}
      - GIT_TOKEN=${GIT_TOKEN:-}
    command: >
      sh -c "
        if [ -n \"$$GIT_TOKEN\" ]; then
          REPO_URL=$$(echo $$GIT_REPO_URL | sed 's|https://|https://$$GIT_TOKEN@|')
        else
          REPO_URL=$$GIT_REPO_URL
        fi &&
        if [ -d /repo/.git ]; then
          echo 'Repository already exists, pulling latest changes...' &&
          cd /repo &&
          git fetch origin &&
          git checkout $$GIT_BRANCH &&
          git pull origin $$GIT_BRANCH
        else
          echo 'Cloning repository...' &&
          git clone -b $$GIT_BRANCH $$REPO_URL /repo
        fi &&
        echo 'Repository ready at /repo'
      "
    restart: "no"
    profiles:
      - clone
